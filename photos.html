export default {
  async fetch(req, env) {
    const url = new URL(req.url);

    // CORS
    const cors = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    };
    if (req.method === "OPTIONS") return new Response(null, { headers: cors });

    // Health check
    if (url.pathname === "/") {
      return new Response("delco-photos worker ok", { headers: cors });
    }

    // Serve a thumbnail as JPEG (works for HEIC/MOV too)
    // /thumb?path=/file/path/in/dropbox
    if (url.pathname === "/thumb") {
      const path = url.searchParams.get("path");
      if (!path) return new Response("Missing path", { status: 400, headers: cors });

      const r = await fetch("https://content.dropboxapi.com/2/files/get_thumbnail_v2", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${env.DROPBOX_ACCESS_TOKEN}`,
          "Content-Type": "application/json",
          "Dropbox-API-Arg": JSON.stringify({
            resource: { ".tag": "path", path },
            format: "jpeg",
            size: "w640h480",
            mode: "strict",
          }),
        },
      });

      if (!r.ok) {
        const err = await r.text();
        return new Response(err, { status: 500, headers: cors });
      }

      // Dropbox returns JSON in header + binary body
      const contentType = r.headers.get("content-type") || "image/jpeg";
      return new Response(r.body, {
        headers: { ...cors, "Content-Type": contentType, "Cache-Control": "public, max-age=300" },
      });
    }

    // List photos/videos in folder and return thumb URLs + file URLs
    if (url.pathname === "/list") {
      const folderPath = "/File requests/Delco Cup Photo Upload";

      const listResp = await fetch("https://api.dropboxapi.com/2/files/list_folder", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${env.DROPBOX_ACCESS_TOKEN}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          path: folderPath,
          recursive: false,
          include_media_info: true,
          include_deleted: false,
        }),
      });

      if (!listResp.ok) {
        const err = await listResp.text();
        return new Response(
          JSON.stringify(
            {
              error: true,
              dropbox_status: listResp.status,
              body_first_300: err.slice(0, 300),
            },
            null,
            2
          ),
          { status: 500, headers: { ...cors, "Content-Type": "application/json" } }
        );
      }

      const data = await listResp.json();

      // Keep images + videos (for IG-like thumbnails)
      const entries = (data.entries || [])
        .filter((e) => e[".tag"] === "file")
        .filter((e) => /\.(jpg|jpeg|png|webp|gif|heic|mov|mp4)$/i.test(e.name))
        .sort((a, b) => (b.server_modified || "").localeCompare(a.server_modified || ""))
        .slice(0, 120);

      const origin = url.origin;

      // For each file, we return:
      // - thumb: worker-served jpeg thumbnail
      // - file: temporary link (may not open for HEIC in browser, but okay for download)
      const out = [];
      for (const f of entries) {
        const path = f.path_lower;

        // Temporary link for the original file (good for JPG/PNG/MP4; HEIC may download)
        let fileUrl = "";
        try {
          const temp = await fetch("https://api.dropboxapi.com/2/files/get_temporary_link", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${env.DROPBOX_ACCESS_TOKEN}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ path }),
          });
          if (temp.ok) {
            const j = await temp.json();
            fileUrl = j.link || "";
          }
        } catch {}

        out.push({
          name: f.name,
          modified: f.server_modified,
          path,
          thumb: `${origin}/thumb?path=${encodeURIComponent(path)}`,
          file: fileUrl,
        });
      }

      return new Response(JSON.stringify({ photos: out }), {
        headers: { ...cors, "Content-Type": "application/json" },
      });
    }

    return new Response("Not found", { status: 404, headers: cors });
  },
};
